---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(cgdsr)
library(survival)
library(survminer)
library(dplyr)


mycgds = CGDS("http://www.cbioportal.org/public-portal/")
myCancerStudiesDF = getCancerStudies(mycgds) 
mycancerstudies = getCancerStudies(mycgds)[,1]
studies = grepl('pan_can_atlas_2018',mycancerstudies)
studies = mycancerstudies[studies]

studiesDF = data.frame()


for (mycancerstudy in studies){
  mycaselist = getCaseLists(mycgds,mycancerstudy)[1,1]
  myclinicaldata = getClinicalData(mycgds,mycaselist)
  myclinicaldata$sample.id = row.names(myclinicaldata)
  myclinicaldata$sample.id = 
    sapply(as.character(myclinicaldata$sample.id), function(x) 
      str_replace_all(x, "\\.", "-"))
  if(!('PATH_M_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$PATH_M_STAGE='na'}
  if(!('PATH_T_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$PATH_T_STAGE='na'}
  if(!('PATH_N_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$PATH_N_STAGE='na'}
  if(!('AJCC_PATHOLOGIC_TUMOR_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$AJCC_PATHOLOGIC_TUMOR_STAGE='na'}
  
  df <- myclinicaldata %>% dplyr::select(sample.id,
                                             PATH_T_STAGE,
                                             PATH_N_STAGE,
                                             PATH_M_STAGE,
                                             stage = AJCC_PATHOLOGIC_TUMOR_STAGE,
                                         CANCER_TYPE_ACRONYM)
  studiesDF = rbind(studiesDF,df)
}

library(doParallel)
registerDoParallel(cores=4)
studiesDFpar = foreach(mycancerstudy = studies,.combine = rbind)%dopar%{
  mycaselist = getCaseLists(mycgds,mycancerstudy)[1,1]
  myclinicaldata = getClinicalData(mycgds,mycaselist)
  myclinicaldata$sample.id = row.names(myclinicaldata)
  myclinicaldata$sample.id = 
    sapply(as.character(myclinicaldata$sample.id), function(x) 
      str_replace_all(x, "\\.", "-"))
  if(!('PATH_M_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$PATH_M_STAGE='na'}
  if(!('PATH_T_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$PATH_T_STAGE='na'}
  if(!('PATH_N_STAGE' %in% colnames(myclinicaldata))){myclinicaldata$PATH_N_STAGE='na'}
  if(!('AJCC_PATHOLOGIC_TUMOR_STAGE' %in% 
       colnames(myclinicaldata))){myclinicaldata$AJCC_PATHOLOGIC_TUMOR_STAGE='na'}
  
  df <- myclinicaldata %>% dplyr::select(sample.id,
                                             PATH_T_STAGE,
                                             PATH_N_STAGE,
                                             PATH_M_STAGE,
                                             stage = AJCC_PATHOLOGIC_TUMOR_STAGE,
                                         CANCER_TYPE_ACRONYM)
  df

}

studiesDFpar$PATH_M_STAGE %>% unique()
studiesDFpar$PATH_M_combined = "NA"
combinePath = function(x){
  if(grepl('M1',x)){
    return('M1')
  }else if(grepl('M0',x)){
    return('M0')
  }
  else{return('na')}
}
studiesDFpar$PATH_M_combined=sapply(studiesDFpar$PATH_M_STAGE,combinePath)

table(studiesDFpar$PATH_M_combined,
      studiesDFpar$PATH_M_STAGE)

write.csv(studiesDFpar,'../../Data/pancanStage.csv',row.names = F)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

