
db.list <- c( "KEGG_2016",  "GO_Biological_Process_2017", "GO_Cellular_Component_2017") #"WikiPathways_2016" "Biocarta_2016", "ChEA_2016",


#' Perform functional enrichment on a pair of "up"- and "down"- regulated genes sets,
#' such as those generated in a differential expression analysis.
#' 
#' This function wraps enrichGeneList to call Enrichr to perform functional enrichment tests on
#' the provided gene lists, for the databases specified in the databases argument. 
#' Databases are specified as seen in the web interface, with underscores for spaces
#' (e.g. "WikiPathways_2016", "KEGG_2016", "GO_Biological_Process"). There's no way to query Enrichr
#' to get these database names, so they can't be provided as options. You'll just have to guess. Sorry :/
#' 
#' @param up.genes a list of up-regulated gene symbols
#' @param dn.genes a list of down-regulated gene symbols
#' @param databases a list of Enrichr-fronted databases, as mentioned above
#' @param fdr.cutoff An FDR (adjusted p-value) threshold by which to limit the list of enriched pathways
#' @keywords functional enrichment Enrichr
#' @export

#install.packages("data.table")
enrichFullGeneList <- function(up.genes, dn.genes, databases=db.list, fdr.cutoff=NULL) {
  (up.gene.res <- enrichGeneList(up.genes, databases, fdr.cutoff))
  (up.gene.res$direction <- "UP")
  (dn.gene.res <- enrichGeneList(dn.genes, databases, fdr.cutoff))
  dn.gene.res$direction <- "DN"
  (rbind(up.gene.res, dn.gene.res))
}
#this enrichFullGeneList is not recalled back later.
#is there a difference between this and enrichGeneList?
#Also, changed all words with down to dn.
#There is a difference in results betw dn.gene.res (8hits) and down.gene.res (7hits).
#Not only in the num of hits but also the specific hits.


#' Perform functional enrichment on a set of genes.
#' 
#' This function interacts with Enrichr's REST API in order to perform functional enrichment of a single
#' set of genes, for a set of specified databases which are already fronted by Enrichr.
#' Databases are specified as seen in the web interface, with underscores for spaces
#' (e.g. "WikiPathways_2016", "KEGG_2016", "GO_Biological_Process"). There's no way to query Enrichr
#' to get these database names, so they can't be provided as options. You'll just have to guess. Sorry :/
#' 
#' @param gene.list a list of gene symbols
#' @param databases a list of Enrichr-fronted databases, as mentioned above
#' @param fdr.cutoff An FDR (adjusted p-value) threshold by which to limit the list of enriched pathways
#' @keywords functional enrichment Enrichr
#' @export
enrichGeneList <- function (gene.list, databases=db.list, fdr.cutoff=NULL) {
  ######Step 1: Post gene list to EnrichR
  req.body <- list(list=paste(gene.list, collapse="\n"))
  post.req <- httr::POST("http://amp.pharm.mssm.edu/Enrichr/enrich", encode="multipart", body=I(req.body))
  
  #TODO: Real error handling..
  if (!grepl("success", httr::http_status(post.req)$category, ignore.case=T)) stop("Posting gene list to EnrichR failed")
  
  ######Step 2: Get results from posted gene list
  database.enrichments <- list()
  for (idx in 1:length(databases)) { 
    database <- databases[idx]
    get.req <- httr::GET(paste("http://amp.pharm.mssm.edu/Enrichr/enrich?backgroundType=", database, sep=""))
    if (!grepl("success", httr::http_status(get.req)$category, ignore.case=T)) stop("Retrieving results from EnrichR failed")
    
    response.content <- mungeResponseContent(httr::content(get.req)[[database]])
    
    if (length(response.content) > 1) {
      database.res <- data.table::rbindlist(response.content)
      database.res[, 1] <- rep(database, nrow(database.res))
      database.enrichments[[idx]] <- database.res[, paste("V", c(1, 2, 3, 7, 6), sep=""), with=F]
    }
  }
  
  query.results <- as.data.frame(data.table::rbindlist(database.enrichments))
  colnames(query.results) <- c("database", "category", "pval", "qval", "genes")
  
  if (!is.null(fdr.cutoff)) {
    query.results <- query.results[query.results$qval < fdr.cutoff, ]
  }
  
  query.results
}



#' Munge the Enrichr API response so it'll squeeze neatly (if untidily) into a dataframe.
#' 
#' The response from the Enrichr API is a list of lists, where each nested list item represents an enriched
#' category. The 6th item of each category (i.e. response.content[[category.idx]][[6]]) corresponds to the 
#' genes that overlapped with the gene set behind that category. This function bascically collapses that list of 
#' genes into a single string. 
#' 
#' I'm sorry you ever had to look at this.
#' 
#' @param response.content result of calling httr::content on the GET request to the Enrichr API, after submitting a list for enrichment.
#' 
mungeResponseContent <- function (response.content) {
  munged.content <- response.content
  if (length(response.content) == 0) return(NA)
  
  for (idx in 1:length(response.content)) {
    munged.content[[idx]][[6]] <- paste(munged.content[[idx]][[6]], collapse=",")
  }
  
  munged.content
}


#munged.content not found


databases = db.list
fdr.cutoff = 0.25

(up.genes = dz_signature$Symbol[dz_signature$log2FoldChange > 0])
(up.gene.res = enrichGeneList(up.genes[1:min(300, length(up.genes))], databases, fdr.cutoff))
(up.gene.res = up.gene.res[order(up.gene.res$database, up.gene.res$p), ])
write.csv(up.gene.res, paste0(outputFolder, "/dz_up_sig_genes_enriched", ".csv"))


dn.genes = dz_signature$Symbol[dz_signature$log2FoldChange < 0]
dn.gene.res = enrichGeneList(dn.genes[1:min(300, length(dn.genes))], databases, fdr.cutoff)
dn.gene.res = dn.gene.res[order(dn.gene.res$database, dn.gene.res$p), ]
write.csv(dn.gene.res, paste0(outputFolder, "/dz_down_sig_genes_enriched", ".csv"))

