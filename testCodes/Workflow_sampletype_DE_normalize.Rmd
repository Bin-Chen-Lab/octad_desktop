---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(RUVSeq)
library(edgeR)

source('~/Documents/GitHub/OCTAD v180627/octad_desktop/testCodes/DE_core_functions_v2.R')
pipelineDataFolder = '~/Documents/GitHub/OCTAD v180627/Data/'
outputFolder = '~/Documents/GitHub/OCTAD v180627/Subproject Metastatic Cancer/Breast Invasive Carcinoma/'
if (!dir.exists(outputFolder)) {
  dir.create(outputFolder)
}

phenoDF = read.csv(paste0(pipelineDataFolder,'integrated.OCTAD.basic.sample.meta.csv'),stringsAsFactors = F)
phenoDF_breast = phenoDF %>% filter(grepl('BREAST - MAMMARY',biopsy.site,ignore.case = T)|grepl('breast invasive carcinoma',cancer,ignore.case = T)) %>% filter(gender == 'Female')

table(phenoDF_breast$sample.type)
```

```{r}
counts_phenotype <- phenoDF_breast %>% select(sample = sample.id,sample_type = sample.type)
  
#need to set the levels so that the design matrix won't be case as an intercept
counts_phenotype$sample_type <- factor(counts_phenotype$sample_type,levels=c('normal',
                                                                             'adjacent',
                                                                             'primary',
                                                                             'metastatic'))

```

```{r}
load(paste0(pipelineDataFolder,'dz.expr.log2.readCounts.RData'))
dz_exprBreast = dz.expr.log2.read.count[,phenoDF_breast$sample.id]
rm(dz.expr.log2.read.count)

counts = 2^dz_exprBreast - 1

highExprGenes = remLowExpr(counts = counts,
                           counts_phenotype = counts_phenotype)
counts = counts[highExprGenes,]
dim(counts)

```
Empirical Genes
```{r}
set <- newSeqExpressionSet(round(counts),
                             phenoData = data.frame(counts_phenotype,row.names= counts_phenotype$sample))

class(counts_phenotype$sample)

design <- model.matrix(~ sample_type, data = pData(set))
  
y <- DGEList(counts=counts(set), group =  counts_phenotype$sample)
  
y <- calcNormFactors(y, method="TMM") #upperquartile generate Inf in the LGG case
  
y <- estimateGLMCommonDisp(y, design)
  
y <- estimateGLMTagwiseDisp(y, design)
  
  
fit <- glmFit(y, design)
  
lrtMet <- glmLRT(fit,4)
lrtPri <- glmLRT(fit,3)
lrtAdj <- glmLRT(fit,2)
topMet <- topTags(lrtMet, n=nrow(set))$table
topPri <- topTags(lrtPri, n=nrow(set))$table
topAdj <- topTags(lrtAdj, n=nrow(set))$table

#Assumming 5000 ntop
top5000 = union(rownames(topAdj[1:5000,]),union(rownames(topMet[1:5000,]),
            rownames(topPri[1:5000,])))
i = which(!(rownames(set) %in% top5000))
empirical <- rownames(set)[i]
```

```{r}
set1 <- RUVg(set,empirical,k=1)
```

```{r}
library(edgeR)
```

```{r}
design <- model.matrix(~sample_type + W_1,data=pData(set1))
dgList <- DGEList(counts=counts(set1),group=set1$sample_type)
dgList <- calcNormFactors(dgList, method="TMM")
dgList <- estimateGLMCommonDisp(dgList, design)
dgList <- estimateGLMTagwiseDisp(dgList, design)
fit <- glmFit(dgList, design)
save(fit,file=paste0(outputFolder,'breastFit_Normalized_ntop5000.RData'))


padj_function = function(res){
  colnames(res) <- c("log2FoldChange", "logCPM", "LR", "pvalue")
  res$padj <- p.adjust(res$pvalue)
  res$ensembl = row.names(res)
  ensembl_info <- read.csv(paste0(pipelineDataFolder,'/gencode.v23.annotation.gene.probeMap.csv'),
                         stringsAsFactors = F)
  gene_info <- read.csv(paste0(pipelineDataFolder,'/gene_info_hs.csv'),stringsAsFactors = F)
  res = res %>% left_join(ensembl_info %>% select(gene,ensembl),by='ensembl') %>% 
    left_join(gene_info,by=c('gene'='Symbol')) %>% select(ensembl,gene,everything())
  return(res)
}

lrt.adjVnorm <- glmLRT(fit,contrast=c(0,1,0,0,0)) 
lrt.adjVnorm.res = padj_function(lrt.adjVnorm$table)
dz_signature.adjVnorm = lrt.adjVnorm.res %>% filter(abs(log2FoldChange)>2,padj<0.001)

lrt.priVnorm <- glmLRT(fit,contrast=c(0,0,1,0,0)) 
lrt.priVnorm.res = padj_function(lrt.priVnorm$table)
dz_signature.priVnorm = lrt.priVnorm.res %>% filter(abs(log2FoldChange)>2,padj<0.001)

lrt.metVnorm <- glmLRT(fit,contrast=c(0,0,0,1,0)) 
lrt.metVnorm.res = padj_function(lrt.metVnorm$table)
dz_signature.metVnorm = lrt.metVnorm.res %>% filter(abs(log2FoldChange)>2,padj<0.001)

tmp = inner_join(dz_signature.metVnorm %>% select(ensembl,log2FoldChange),
                 dz_signature.priVnorm,by='ensembl') #3209 intersects
cor.test(tmp$log2FoldChange.x %>% rank(),tmp$log2FoldChange.y %>% rank()) 

lrt.metVpri <- glmLRT(fit,contrast=c(0,0,-1,1,0)) 
lrt.metVpri.res = padj_function(lrt.metVpri$table)
dz_signature.metVpri = lrt.metVpri.res %>% filter(abs(log2FoldChange)>2,padj<0.001)

geneEnrich(dz_signature.metVpri)

save(lrt.adjVnorm.res,lrt.priVnorm.res,lrt.metVnorm.res,lrt.metVpri.res,
     dz_signature.adjVnorm,dz_signature.priVnorm,dz_signature.metVnorm,dz_signature.metVpri,
     file=paste0(outputFolder,'DEsigBreast.by_sampletype_normalized.RData'))
```
